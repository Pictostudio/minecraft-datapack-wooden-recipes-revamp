name: Changelog Updating

on:
  workflow_run:
    workflows: ["Versioning"] 
    types:
      - completed

permissions:
  contents: write

jobs:
  changelog:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 

      - name: Read version
        run: |
          VERSION=$(cat VERSION)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Current version: $VERSION"

      - name: Check last commit author
        run: |
          AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Commit author: $AUTHOR"

          if [[ "$AUTHOR" == "JordanPicton" ]]; then
            echo "UPDATE=true" >> $GITHUB_ENV
          else
            echo "UPDATE=false" >> $GITHUB_ENV

      - name: Get last commit message
        if: env.UPDATE == 'true'
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "COMMIT_MSG<<EOF" >> $GITHUB_ENV
          echo "$COMMIT_MSG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Update CHANGELOG.md
        if: env.UPDATE == 'true'
        run: |
          CHANGELOG="CHANGELOG.md"
          VERSION_HEADER="# $VERSION"

          # Create file if missing
          if [ ! -f "$CHANGELOG" ]; then
            echo "$VERSION_HEADER" > "$CHANGELOG"
            echo "" >> "$CHANGELOG"
          fi

          # If version header does not exist, add it at top
          if ! grep -q "^$VERSION_HEADER" "$CHANGELOG"; then
            cp "$CHANGELOG" "$CHANGELOG.tmp"
            echo "$VERSION_HEADER" > "$CHANGELOG"
            echo "" >> "$CHANGELOG"
            echo "" >> "$CHANGELOG"
            cat "$CHANGELOG.tmp" >> "$CHANGELOG"
            rm "$CHANGELOG.tmp"
          fi

          # Append commit message under the correct version
          awk -v ver="$VERSION_HEADER" -v msg="$COMMIT_MSG" '
            $0 == ver {
              print;
              print "- " msg;
              next
            }
            { print }
          ' "$CHANGELOG" > "$CHANGELOG.new"
          mv "$CHANGELOG.new" "$CHANGELOG"

      - name: Commit updated CHANGELOG.md
        if: env.UPDATE == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add CHANGELOG.md
          git commit -m "Updated changelog for version $VERSION"
          git push