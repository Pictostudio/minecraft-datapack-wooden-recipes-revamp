name: Versioning
on: 
  # On pushes to the development branch then run the below.
  push:
    branches:
      - development
jobs:
  versioning:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Code
        uses: actions/checkout@v6

      # Reads the current version from file.
      - name: Read Version
        run: |
          VERSION=$(cat VERSION)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Current version: $VERSION"

      # Detects the commit messages for use later.
      - name: Detect Commits
      # The below gets the last commit message and makes it pretty.
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B) 
          BUMP="patch"

          if [[ "$COMMIT_MSG" == *"feat:"* ]]; then
            BUMP="major"
          elif [[ "$COMMIT_MSG" == *"fix:"* ]]; then
            BUMP="minor"
          fi

          ADDED_DIRS=$(git diff --name-status HEAD~1 HEAD | grep "^A" | grep "^wrr-" || true)
          if [[ ! -z "$ADDED_DIRS" && "$BUMP" == "patch" ]]; then
            BUMP="major"
          fi

          echo "BUMP=$BUMP" >> $GITHUB_ENV
          echo "COMMIT_MSG<<EOF" >> $GITHUB_ENV
          echo "$COMMIT_MSG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Update Version
        run: |
          # Only update the last number, keep MAJOR and MINOR at 0
          PATCH=$(echo $VERSION | cut -d. -f3)

          if [[ "$BUMP" == "major" ]]; then
            PATCH=$((PATCH + 5))
          elif [[ "$BUMP" == "minor" ]]; then
            PATCH=$((PATCH + 3))
          else
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="0.0.$PATCH"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "$NEW_VERSION" > VERSION
          echo "New version: $NEW_VERSION"