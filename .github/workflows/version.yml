name: Versioning
on: 
  # On pushes to the development branch then run the below.
  push:
    branches:
      - development
jobs:
  versioning:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Code
        uses: actions/checkout@v6
    # Reads the current version from file.
      - name:  Read Version
        run: |
          VERSION=$(cat VERSION)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Current version: $VERSION"

        #  Detects the commit messages for use later.
      - name: Detect Commits
      # The below gets the last commit message and makes it pretty.
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B) 
          BUMP="patch"

          if [[ "$COMMIT_MSG" == *"feat:"* ]]; then
            BUMP="major"
          elif [[ "$COMMIT_MSG" == *"fix:"* ]]; then
            BUMP="minor"
          fi

          ADDED_DIRS=$(git diff --name-status ${{ github.event.before }} ${{ github.sha }} | grep "^A" | grep "^wrr-" || true)
          if [[ ! -z "$ADDED_DIRS" && "$BUMP" == "patch" ]]; then
            BUMP="major"
          fi

          echo "BUMP=$BUMP" >> $GITHUB_ENV
          echo "COMMIT_MSG<<EOF" >> $GITHUB_ENV
          echo "$COMMIT_MSG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Update Version
        run: |
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          if [[ "$BUMP" == "major" ]]; then
            MAJOR=$((MAJOR + 5))
            MINOR=0
            PATCH=0
          elif [[ "$BUMP" == "minor" ]]; then
            MINOR=$((MINOR + 3))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "$NEW_VERSION" > VERSION
          echo "New version: $NEW_VERSION"